AWSTemplateFormatVersion: '2010-09-09'

Description: Overarching CF Template to Create Security Groups and Messaging Resources for AEM Appp Stacks

Parameters:

  PrerequisitesStackPrefixParameter:
    Type: String
    Description: The AEM Stack Prerequisite Resources Stack Prefix

  NetworkStackPrefixParameter:
    Type: String
    Description: The AEM Stack Network Resources Stack Prefix

  DataBucketNameParameter:
    Type: String
    Description: Bucket name that stores Stack data files

  SecureShellInboundCidrIpParameter:
    Type: String
    Description: AEM Stack Secure Shell Inbound Cidr Ip

  PublishDispatcherELBSecurityGroupInboundCidrIpParameter:
    Type: String
    Description: AEM Publish Dispatcher ELB Security Group Inbound Cidr Ip

  AuthorDispatcherELBSecurityGroupInboundCidrIpParameter:
    Type: String
    Description: AEM Author Dispatcher ELB Security Group Inbound Cidr Ip

  PrivateSubnetInternetOutboundCidrIpParameter:
    Type: String
    Description: AEM Stack Private Subnet Internet Outbound Cidr Ip Destination

  AEMASGEventQueueNameParameter:
    Type: String
    Description: The AEM Stack Auto Scaling Group Event Quene Name

  AEMASGEventTopicDisplayNameParameter:
    Type: String
    Description: The AEM Stack Auto Scaling Group Event Topic Display Name

  AEMASGEventTopicNameParameter:
    Type: String
    Description: The AEM Stack Auto Scaling Group Event Topic Name

  AEMCWEventNotificationEmail:
    Type: String
    Description: The EMail adress for sending CW Alarm messages

Resources:

  InstanceProfilesStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::Sub: https://s3-${AWS::Region}.amazonaws.com/${DataBucketNameParameter}/${PrerequisitesStackPrefixParameter}/instance-profiles.yaml
      Parameters:
        InstanceProfilesStackPrefixParameter:
          Ref: PrerequisitesStackPrefixParameter

  SecurityGroupsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::Sub: https://s3-${AWS::Region}.amazonaws.com/${DataBucketNameParameter}/${PrerequisitesStackPrefixParameter}/security-groups.yaml
      Parameters:
        SecurityGroupsStackPrefixParameter:
          Ref: PrerequisitesStackPrefixParameter
        NetworkStackPrefixParameter:
          Ref: NetworkStackPrefixParameter
        SecureShellInboundCidrIpParameter:
          Ref: SecureShellInboundCidrIpParameter
        PublishDispatcherELBSecurityGroupInboundCidrIpParameter:
          Ref: PublishDispatcherELBSecurityGroupInboundCidrIpParameter
        AuthorDispatcherELBSecurityGroupInboundCidrIpParameter:
          Ref: AuthorDispatcherELBSecurityGroupInboundCidrIpParameter
        PrivateSubnetInternetOutboundCidrIpParameter:
          Ref: PrivateSubnetInternetOutboundCidrIpParameter

  MessagingStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::Sub: https://s3-${AWS::Region}.amazonaws.com/${DataBucketNameParameter}/${PrerequisitesStackPrefixParameter}/messaging.yaml
      Parameters:
        MessagingStackPrefixParameter:
          Ref: PrerequisitesStackPrefixParameter
        AEMASGEventQueueNameParameter:
          Ref: AEMASGEventQueueNameParameter
        AEMASGEventTopicDisplayNameParameter:
          Ref: AEMASGEventTopicDisplayNameParameter
        AEMASGEventTopicNameParameter:
          Ref: AEMASGEventTopicNameParameter
        AEMCWEventNotificationEmail:
          Ref: AEMCWEventNotificationEmail

Outputs:

  InstanceProfilesStackName:
    Description: Instance Profiles Stack Name
    Value:
      Ref: InstanceProfilesStack
    Export:
      Name:
        Fn::Sub: ${PrerequisitesStackPrefixParameter}-InstanceProfilesStackName

  SecurityGroupsStackName:
    Description: Security Groups Stack Name
    Value:
      Ref: SecurityGroupsStack
    Export:
      Name:
        Fn::Sub: ${PrerequisitesStackPrefixParameter}-SecurityGroupsStackName

  MessagingStackName:
    Description: Messaging Stack Name
    Value:
      Ref: MessagingStack
    Export:
      Name:
        Fn::Sub: ${PrerequisitesStackPrefixParameter}-MessagingStackName
